"use strict";(()=>{var a={};a.id=964,a.ids=[964],a.modules={261:a=>{a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:a=>{a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},19121:a=>{a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},26069:(a,b,c)=>{c.d(b,{m_:()=>e,yI:()=>d});class d extends Error{constructor(a,b,c){super(a),this.field=b,this.value=c,this.name="ValidationError"}}class e extends Error{constructor(a,b){super(`${a} with identifier '${b}' not found`),this.name="NotFoundError"}}},29021:a=>{a.exports=require("fs")},29294:a=>{a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:a=>{a.exports=require("path")},44432:(a,b,c)=>{c.d(b,{m:()=>n});var d=c(48689),e=c(85766),f=c(71559),g=c(69334),h=c(87280),i=c(71491),j=c(27628),k=c(26069);let l={getById:i.db.select().from(j.executions).where((0,d.eq)(j.executions.id,e.ll.placeholder("id"))).prepare(),getByStatus:i.db.select().from(j.executions).where((0,d.eq)(j.executions.status,e.ll.placeholder("status"))).prepare(),getRecentExecutions:i.db.select().from(j.executions).orderBy((0,f.i)(j.executions.startedAt)).limit(e.ll.placeholder("limit")).prepare(),updateStatus:i.db.update(j.executions).set({status:e.ll.placeholder("status"),updatedAt:e.ll.placeholder("updatedAt")}).where((0,d.eq)(j.executions.id,e.ll.placeholder("id"))).prepare()};class m{async createExecution(a){try{this.validateExecutionData(a);let b={id:(0,h.sX)(),...a,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},[c]=await i.db.insert(j.executions).values(b).returning();return{success:!0,data:c,affectedRows:1}}catch(a){return this.handleError("createExecution",a)}}async getExecutionById(a,b={}){try{if(b.includeSteps||b.includeCosts||b.includeConfig){let c=await i.db.query.executions.findFirst({where:(0,d.eq)(j.executions.id,a),with:{steps:b.includeSteps?{orderBy:(a,{asc:b})=>[b(a.stepNumber)]}:void 0,costBreakdown:b.includeCosts,agentConfig:b.includeConfig}});if(!c)throw new k.m_("Execution",a);let e={...c,steps:c.steps||[],costBreakdown:c.costBreakdown||[],agentConfig:c.agentConfig||null,parsedLogs:b.includeParsedData&&c.logs?JSON.parse(c.logs):null,parsedAiAnalysis:b.includeParsedData&&c.aiAnalysis?JSON.parse(c.aiAnalysis):null,parsedExecutionContext:b.includeParsedData&&c.executionContext?JSON.parse(c.executionContext):null};return{success:!0,data:e}}{let[b]=await l.getById.execute({id:a});if(!b)throw new k.m_("Execution",a);return{success:!0,data:b}}}catch(a){return this.handleError("getExecutionById",a)}}async updateExecution(a,b){try{let c={...b,updatedAt:new Date().toISOString()};b.logs&&Array.isArray(b.logs)&&(c.logs=JSON.stringify(b.logs)),b.aiAnalysis&&"object"==typeof b.aiAnalysis&&(c.aiAnalysis=JSON.stringify(b.aiAnalysis));let[e]=await i.db.update(j.executions).set(c).where((0,d.eq)(j.executions.id,a)).returning();if(!e)throw new k.m_("Execution",a);return{success:!0,data:e,affectedRows:1}}catch(a){return this.handleError("updateExecution",a)}}async deleteExecution(a,b=!1){try{if(b){let b=await i.db.delete(j.executions).where((0,d.eq)(j.executions.id,a));return{success:!0,affectedRows:b.changes}}{let[b]=await i.db.update(j.executions).set({status:"cancelled",updatedAt:new Date().toISOString()}).where((0,d.eq)(j.executions.id,a)).returning();if(!b)throw new k.m_("Execution",a);return{success:!0,affectedRows:1}}}catch(a){return this.handleError("deleteExecution",a)}}async getExecutions(a={},b={}){try{let b=this.buildExecutionConditions(a),{limit:c=50,offset:e=0}=a,h=i.db.select().from(j.executions);b.length>0&&(h=h.where((0,d.Uo)(...b))),h=h.orderBy((0,f.i)(j.executions.startedAt));let k=i.db.select({count:(0,g.U9)()}).from(j.executions);b.length>0&&(k=k.where((0,d.Uo)(...b)));let[{count:l}]=await k,m=await h.limit(c).offset(e);return{success:!0,data:{data:m,total:l,page:Math.floor(e/c)+1,pageSize:c,hasMore:e+m.length<l}}}catch(a){return this.handleError("getExecutions",a)}}async getRunningExecutions(){try{let a=await l.getByStatus.execute({status:"running"});return{success:!0,data:a}}catch(a){return this.handleError("getRunningExecutions",a)}}async getExecutionStats(a){try{let b=i.db.select({total:(0,g.U9)(),running:(0,e.ll)`COUNT(CASE WHEN status = 'running' THEN 1 END)`,completed:(0,e.ll)`COUNT(CASE WHEN status = 'completed' THEN 1 END)`,failed:(0,e.ll)`COUNT(CASE WHEN status = 'failed' THEN 1 END)`,cancelled:(0,e.ll)`COUNT(CASE WHEN status = 'cancelled' THEN 1 END)`,pending:(0,e.ll)`COUNT(CASE WHEN status = 'pending' THEN 1 END)`,avgDuration:(0,e.ll)`AVG(duration_ms)`,totalCost:(0,e.ll)`SUM(cost_usd)`}).from(j.executions);a&&(b=b.where((0,d.eq)(j.executions.agentType,a)));let[c]=await b,f=c.total>0?c.completed/c.total*100:0,h={total:c.total,running:c.running,completed:c.completed,failed:c.failed,cancelled:c.cancelled,pending:c.pending,completionRate:f,averageDuration:c.avgDuration,totalCost:c.totalCost};return{success:!0,data:h}}catch(a){return this.handleError("getExecutionStats",a)}}async addExecutionStep(a){try{this.validateStepData(a);let b={id:(0,h.sX)(),...a,createdAt:new Date().toISOString(),metadata:a.metadata?JSON.stringify(a.metadata):void 0},[c]=await i.db.insert(j.executionSteps).values(b).returning();return{success:!0,data:c,affectedRows:1}}catch(a){return this.handleError("addExecutionStep",a)}}async updateExecutionStep(a,b){try{let c={...b,metadata:b.metadata?JSON.stringify(b.metadata):void 0},[e]=await i.db.update(j.executionSteps).set(c).where((0,d.eq)(j.executionSteps.id,a)).returning();if(!e)throw new k.m_("ExecutionStep",a);return{success:!0,data:e,affectedRows:1}}catch(a){return this.handleError("updateExecutionStep",a)}}async getExecutionSteps(a){try{let b=await i.db.select().from(j.executionSteps).where((0,d.eq)(j.executionSteps.executionId,a)).orderBy((0,f.Y)(j.executionSteps.stepNumber));return{success:!0,data:b}}catch(a){return this.handleError("getExecutionSteps",a)}}async cancelExecution(a,b){try{let[c]=await i.db.update(j.executions).set({status:"cancelled",completedAt:new Date().toISOString(),errorMessage:b||"Execution cancelled by user",exitCode:130,updatedAt:new Date().toISOString()}).where((0,d.eq)(j.executions.id,a)).returning();if(!c)throw new k.m_("Execution",a);return{success:!0,data:c,affectedRows:1}}catch(a){return this.handleError("cancelExecution",a)}}async getRecentActivity(a=10){try{let b=await i.db.select({id:j.executions.id,agentType:j.executions.agentType,status:j.executions.status,startedAt:j.executions.startedAt,completedAt:j.executions.completedAt,duration:j.executions.durationMs,cost:j.executions.costUsd,summary:j.executions.resultSummary}).from(j.executions).orderBy((0,f.i)(j.executions.startedAt)).limit(a);return{success:!0,data:b}}catch(a){return this.handleError("getRecentActivity",a)}}async getExecutionTrends(a=7){try{let b=new Date,c=new Date(b.getTime()-24*a*36e5),f=new Date(c.getTime()-24*a*36e5),[h]=await i.db.select({total:(0,g.U9)(),completed:(0,e.ll)`COUNT(CASE WHEN status = 'completed' THEN 1 END)`,avgDuration:(0,e.ll)`AVG(duration_ms)`,totalCost:(0,e.ll)`SUM(cost_usd)`}).from(j.executions).where((0,d.RO)(j.executions.startedAt,c.toISOString())),[k]=await i.db.select({total:(0,g.U9)(),completed:(0,e.ll)`COUNT(CASE WHEN status = 'completed' THEN 1 END)`,avgDuration:(0,e.ll)`AVG(duration_ms)`,totalCost:(0,e.ll)`SUM(cost_usd)`}).from(j.executions).where((0,d.Uo)((0,d.RO)(j.executions.startedAt,f.toISOString()),(0,d.wJ)(j.executions.startedAt,c.toISOString()))),l=(a,b)=>0===b?100*(a>0):(a-b)/b*100,m=h.total>0?h.completed/h.total*100:0,n=k.total>0?k.completed/k.total*100:0,o={totalChange:l(h.total,k.total),completionRateChange:l(m,n),averageDurationChange:l(h.avgDuration||0,k.avgDuration||0),costChange:l(h.totalCost||0,k.totalCost||0)};return{success:!0,data:o}}catch(a){return this.handleError("getExecutionTrends",a)}}buildExecutionConditions(a){let b=[];return a.agentType&&b.push((0,d.eq)(j.executions.agentType,a.agentType)),a.status&&b.push((0,d.eq)(j.executions.status,a.status)),a.dateFrom&&b.push((0,d.RO)(j.executions.startedAt,a.dateFrom.toISOString())),a.dateTo&&b.push((0,d.wJ)(j.executions.startedAt,a.dateTo.toISOString())),a.nodeId&&b.push((0,d.eq)(j.executions.nodeId,a.nodeId)),a.triggeredBy&&b.push((0,d.eq)(j.executions.triggeredBy,a.triggeredBy)),b}validateExecutionData(a){if(!a.agentType)throw new k.yI("agentType is required","agentType");if(a.status&&!["pending","running","completed","failed","cancelled"].includes(a.status))throw new k.yI("Invalid status value","status",a.status);if(void 0!==a.costUsd&&a.costUsd<0)throw new k.yI("Cost cannot be negative","costUsd",a.costUsd);if(void 0!==a.tokensUsed&&a.tokensUsed<0)throw new k.yI("Tokens used cannot be negative","tokensUsed",a.tokensUsed);if(void 0!==a.durationMs&&a.durationMs<0)throw new k.yI("Duration cannot be negative","durationMs",a.durationMs)}validateStepData(a){if(!a.executionId)throw new k.yI("executionId is required","executionId");if(!a.stepName)throw new k.yI("stepName is required","stepName");if(a.stepNumber<1)throw new k.yI("stepNumber must be positive","stepNumber",a.stepNumber);if(a.status&&!["pending","running","completed","failed","skipped"].includes(a.status))throw new k.yI("Invalid step status","status",a.status)}handleError(a,b){return(console.error(`ExecutionService.${a} error:`,b),b instanceof k.yI||b instanceof k.m_)?{success:!1,error:b.message}:{success:!1,error:b instanceof Error?b.message:"Unknown database error"}}}let n=new m},44870:a=>{a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},63033:a=>{a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},69334:(a,b,c)=>{c.d(b,{T9:()=>j,U9:()=>g,Zf:()=>h,cz:()=>i,jk:()=>k});var d=c(80228),e=c(46493),f=c(85766);function g(a){return(0,f.ll)`count(${a||f.ll.raw("*")})`.mapWith(Number)}function h(a){return(0,f.ll)`avg(${a})`.mapWith(String)}function i(a){return(0,f.ll)`sum(${a})`.mapWith(String)}function j(a){return(0,f.ll)`max(${a})`.mapWith((0,e.is)(a,d.V)?a:String)}function k(a){return(0,f.ll)`min(${a})`.mapWith((0,e.is)(a,d.V)?a:String)}},77598:a=>{a.exports=require("node:crypto")},81966:(a,b,c)=>{c.r(b),c.d(b,{handler:()=>E,patchFetch:()=>D,routeModule:()=>z,serverHooks:()=>C,workAsyncStorage:()=>A,workUnitAsyncStorage:()=>B});var d={};c.r(d),c.d(d,{POST:()=>y});var e=c(95736),f=c(9117),g=c(4044),h=c(39326),i=c(32324),j=c(261),k=c(54290),l=c(85328),m=c(38928),n=c(46595),o=c(3421),p=c(17679),q=c(41681),r=c(63446),s=c(86439),t=c(51356),u=c(59507),v=c(1003),w=c(44432);let x=u.Ikc({reason:u.YjP().optional()}).optional(),y=(0,v.FB)(async(a,b)=>{let c,{id:d}=b.params;try{let b=await a.json(),d=x.parse(b);if(c=d?.reason,void 0!==c&&"string"!=typeof c)return(0,v.sq)(()=>Promise.reject(Error("Reason must be a string")),400)}catch(a){if(!(a instanceof SyntaxError))return(0,v.sq)(()=>Promise.reject(Error("Invalid request body")),400);c=void 0}return(0,v.sq)(()=>w.m.cancelExecution(d,c),202)}),z=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/executions/[id]/cancel/route",pathname:"/api/executions/[id]/cancel",filename:"route",bundlePath:"app/api/executions/[id]/cancel/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"/home/jmagar/code/agents/src/app/api/executions/[id]/cancel/route.ts",nextConfigOutput:"standalone",userland:d}),{workAsyncStorage:A,workUnitAsyncStorage:B,serverHooks:C}=z;function D(){return(0,g.patchFetch)({workAsyncStorage:A,workUnitAsyncStorage:B})}async function E(a,b,c){var d;let e="/api/executions/[id]/cancel/route";"/index"===e&&(e="/");let g=await z.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:y,routerServerContext:A,isOnDemandRevalidate:B,revalidateOnlyGenerated:C,resolvedPathname:D}=g,E=(0,j.normalizeAppPath)(e),F=!!(y.dynamicRoutes[E]||y.routes[D]);if(F&&!x){let a=!!y.routes[D],b=y.dynamicRoutes[E];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let G=null;!F||z.isDev||x||(G="/index"===(G=D)?"/":G);let H=!0===z.isDev||!F,I=F&&!H,J=a.method||"GET",K=(0,i.getTracer)(),L=K.getActiveScopeSpan(),M={params:v,prerenderManifest:y,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:H,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:I,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>z.onRequestError(a,b,d,A)},sharedContext:{buildId:u}},N=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(N,(0,l.signalFromNodeResponse)(b));try{let d=async c=>z.handle(P,M).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=K.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${J} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${J} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&B&&C&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=M.renderOpts.fetchMetrics;let i=M.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=M.renderOpts.collectedTags;if(!F)return await (0,o.I)(N,O,e,M.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,d=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await z.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:B})},A),b}},l=await z.handleResponse({req:a,nextConfig:w,cacheKey:G,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:B,revalidateOnlyGenerated:C,responseGenerator:k,waitUntil:c.waitUntil});if(!F)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",B?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&F||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};L?await g(L):await K.withPropagatedContext(a.headers,()=>K.trace(m.BaseServerSpan.handleRequest,{spanName:`${J} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":J,"http.target":a.url}},g))}catch(b){if(L||b instanceof s.NoFallbackError||await z.onRequestError(a,b,{routerKind:"App Router",routePath:E,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:B})}),F)throw b;return await (0,o.I)(N,O,new Response(null,{status:500})),null}}},86439:a=>{a.exports=require("next/dist/shared/lib/no-fallback-error.external")},87550:a=>{a.exports=require("better-sqlite3")}};var b=require("../../../../../webpack-runtime.js");b.C(a);var c=b.X(0,[586,923,213],()=>b(b.s=81966));module.exports=c})();