# ClaudeOps Docker Compose Configuration
# Production deployment with monitoring and backup services

# Docker Compose version is now automatically detected

services:
  # Main ClaudeOps Application
  claudeops:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
    container_name: claudeops-app
    restart: unless-stopped
    ports:
      - "3000:3000"
      - "3001:3001"
    environment:
      # Core Configuration
      NODE_ENV: production
      NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:-https://claudeops.yourdomain.com}
      NEXT_PUBLIC_APP_NAME: ClaudeOps
      
      # Database
      DATABASE_URL: sqlite:/app/data/production.db
      
      # API Keys
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      
      # WebSocket Configuration
      WEBSOCKET_PORT: 3001
      WEBSOCKET_HOST: 0.0.0.0
      
      # Security
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET}
      NEXTAUTH_URL: ${NEXT_PUBLIC_APP_URL:-https://claudeops.yourdomain.com}
      
      # Cost Management
      COST_ALERT_THRESHOLD: ${COST_ALERT_THRESHOLD:-50.00}
      MONTHLY_BUDGET_LIMIT: ${MONTHLY_BUDGET_LIMIT:-500.00}
      COST_BUDGET_DAILY: ${COST_BUDGET_DAILY:-25.00}
      COST_BUDGET_MONTHLY: ${COST_BUDGET_MONTHLY:-500.00}
      
      # Agent Configuration
      MAX_CONCURRENT_EXECUTIONS: ${MAX_CONCURRENT_EXECUTIONS:-5}
      MAX_CONCURRENT_AGENTS: ${MAX_CONCURRENT_AGENTS:-5}
      DEFAULT_AGENT_TIMEOUT: ${DEFAULT_AGENT_TIMEOUT:-300000}
      AGENT_MEMORY_LIMIT: ${AGENT_MEMORY_LIMIT:-1024}
      AGENT_CPU_LIMIT: ${AGENT_CPU_LIMIT:-80}
      
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-warn}
      LOG_FILE_PATH: /app/logs/claudeops-production.log
      
      # Performance
      CONFIG_CACHE_TTL: ${CONFIG_CACHE_TTL:-300000}
      DISABLE_HOT_RELOAD: true
      
      # Health Check
      HEALTH_CHECK_INTERVAL: ${HEALTH_CHECK_INTERVAL:-60000}
      HEALTH_CHECK_TIMEOUT: ${HEALTH_CHECK_TIMEOUT:-10000}
      
      # Rate Limiting
      RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS:-900000}
      RATE_LIMIT_MAX_REQUESTS: ${RATE_LIMIT_MAX_REQUESTS:-1000}
      
      # Monitoring
      ENABLE_METRICS: ${ENABLE_METRICS:-true}
      METRICS_PORT: ${METRICS_PORT:-9090}
      
      # Backup
      BACKUP_ENABLED: ${BACKUP_ENABLED:-true}
      BACKUP_INTERVAL_HOURS: ${BACKUP_INTERVAL_HOURS:-24}
      BACKUP_RETENTION_DAYS: ${BACKUP_RETENTION_DAYS:-30}
    
    volumes:
      # Persistent data
      - claudeops_data:/app/data
      - claudeops_logs:/app/logs
      - claudeops_temp:/app/temp
      
      # Optional: SSL certificates
      - ${SSL_CERTS_PATH:-./certs}:/app/certs:ro
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/system/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    networks:
      - claudeops-network

# Named volumes for data persistence
volumes:
  claudeops_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}
  
  claudeops_temp:
    driver: local

# Network configuration
networks:
  claudeops-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
